<?xml version="1.0" encoding="utf-8"?>
<mdscript name="al_subsystem_targeting_orders" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
	<cues>
		<cue name="OnLuaLoaderReady">
	      <conditions>
	        <event_ui_triggered screen="'Lua_Loader'" control="'Ready'" />
	      </conditions>
	      <actions>
			<raise_lua_event name="'Lua_Loader.Load'" param="'extensions.al_subsystem_targeting_orders.extension_check'"/>
	      </actions>
	    </cue>
	    <cue name="OnLuaLoaderReadyCompleted">
	      <conditions>
	        <event_cue_completed cue="OnLuaLoaderReady" />
	      </conditions>
	      <actions>
	        <reset_cue cue="OnLuaLoaderReady" />
	        <reset_cue cue="this" />
	      </actions>
	    </cue>
		<cue name="WeaponModeChange" instantiate="true" namespace="this">
    	  <conditions>
    	    <event_ui_triggered screen="'WeaponModeChanged'" control="'onWeaponModeSelected'" />
    	  </conditions>
    	  <actions>
    	    <debug_text text="'WeaponMode selected! Mode is: %s'.[event.param3]" chance="0" />
    	  </actions>
    	</cue>
		<cue name="alASTO" namespace="this">
			<conditions>
				<check_any>
					<event_cue_signalled cue="md.Setup.GameStart" />
					<event_game_loaded />
				</check_any>
			</conditions>
			<actions>
				<debug_text text="'event.name: ' + event.name" />
				<set_value name="$debugChance" exact="100" />
			</actions>
			<cues>
				<cue name="Init">
					<conditions>
						<check_any>
							<event_cue_signalled />
							<event_game_loaded />
						</check_any>
					</conditions>
					<actions>
						<debug_text text="'$debugChance: ' + $debugChance" />

						<reset_cue cue="this" />
					</actions>
				</cue>
				<cue name="OnModInstall">
					<actions>
						<debug_text text="'$debugChance: ' + $debugChance" />
						<signal_cue cue="Init" />
					</actions>
				</cue>
				<cue name="InteractMenu_AddAttackSubsystems" instantiate="true">
					<conditions>
						<event_cue_signalled cue="md.Interact_Menu_API.Get_Actions" />
					</conditions>
					<actions>
						<set_value name="$ship" exact="@event.param.$selectedplayerships.{1}" />
						<set_value name="$target" exact="@event.param.$object" />
						<debug_text text="'$ship: ' + $ship + ' (' + @$ship.knownname + ')'" chance="alASTO.$debugChance" />
						<do_if value="$ship and $ship.owner == faction.player">
							<set_value name="$section" exact="'selected_orders'" />
							
							<do_if value="($target.isclass.ship or $target.isclass.station) and (not ($target.owner == faction.player))">	
								<set_value name="$disable_flag" exact="false" />
								
								<do_if value="@$target.iscapitalship">
									<find_object_component name="$subsys" object="$target" class="class.engine" checkoperational="true" indestructible="false" invulnerable="false" integrated="false" multiple="false"/>	  
									<do_if value="$subsys">
										<set_value name="$disable_flag" exact="true" />
										<set_value name="$text" exact="{92015, 2000}" comment="Attack Engines" />
										<signal_cue_instantly cue="md.Interact_Menu_API.Add_Action" param = "table[
											$id = 'order_attack_subsystem',
											$section = $section,
											$text = $text,
											$icon = 'order_attack',
											$callback = InteractMenu_OnAttackSubSys,
											$echo='engines'
										]" />
									</do_if>
								</do_if>
								
								<do_if value="@$target.iscapitalship or $target.isclass.station">
									<find_object_component name="$subsys" object="$target" class="class.shieldgenerator" checkoperational="true" indestructible="false" invulnerable="false" integrated="false" multiple="false"  tags="[tag.large, tag.extralarge]"/>	  
									<do_if value="$subsys">
										<set_value name="$disable_flag" exact="true" />
										<set_value name="$text" exact="{92015, 2001}" comment="Attack Shields" />
										<signal_cue_instantly cue="md.Interact_Menu_API.Add_Action" param = "table[
											$id = 'order_attack_shields',
											$section = $section,
											$text = $text,
											$icon = 'order_attack',
											$callback = InteractMenu_OnAttackSubSys,
											$echo='shields'
										]" />
									</do_if>

									<find_object_component name="$subsys" object="$target" class="[class.turret]" checkoperational="true" indestructible="false" invulnerable="false" integrated="false" multiple="false" tags="[tag.small, tag.medium]"/>	
									<do_if value="$subsys">
										<set_value name="$disable_flag" exact="true" />
										<set_value name="$text" exact="{92015, 2002}" comment="Attack M Turrets" />
										<signal_cue_instantly cue="md.Interact_Menu_API.Add_Action" param = "table[
											$id = 'order_attack_m_turrets',
											$section = $section,
											$text = $text,
											$icon = 'order_attack',
											$callback = InteractMenu_OnAttackSubSys,
											$echo='weps_m'
										]" />
									</do_if>
									
									<find_object_component name="$subsys" object="$target" class="[class.turret]" checkoperational="true" indestructible="false" invulnerable="false" integrated="false" multiple="false" tags="[tag.large, tag.extralarge]"/>										
									<do_if value="$subsys">
										<set_value name="$disable_flag" exact="true" />
										<set_value name="$text" exact="{92015, 2003}" comment="Attack L Turrets" />
										<signal_cue_instantly cue="md.Interact_Menu_API.Add_Action" param = "table[
											$id = 'order_attack_l_turrets',
											$section = $section,
											$text = $text,
											$icon = 'order_attack',
											$callback = InteractMenu_OnAttackSubSys,
											$echo='weps_l'
										]" />					
									</do_if>

									<find_object_component name="$subsys" object="$target" class="[class.missileturret]" checkoperational="true" indestructible="false" invulnerable="false" integrated="false" multiple="false"/>	  											
									<do_if value="$subsys">
										<set_value name="$disable_flag" exact="true" />
										<set_value name="$text" exact="{92015, 2004}" comment="Attack Miss Turrets" />
										<signal_cue_instantly cue="md.Interact_Menu_API.Add_Action" param = "table[
											$id = 'order_attack_missturr',
											$section = $section,
											$text = $text,
											$icon = 'order_attack',
											$callback = InteractMenu_OnAttackSubSys,
											$echo='missiles'
										]" />
									</do_if>

									<find_object_component name="$subsys" object="$target" class="[class.weapon]" checkoperational="true" indestructible="false" invulnerable="false" integrated="false" multiple="false" tags="[tag.weapon]">
										<match class="class.turret" negate="true"/>
									</find_object_component>
									<do_if value="$subsys">
										<set_value name="$disable_flag" exact="true" />
										<set_value name="$text" exact="{92015, 2005}" comment="Attack Main Batteries" />
										<signal_cue_instantly cue="md.Interact_Menu_API.Add_Action" param = "table[
											$id = 'order_attack_batteries',
											$section = $section,
											$text = $text,
											$icon = 'order_attack',
											$callback = InteractMenu_OnAttackSubSys,
											$echo='batteries'
										]" />					
									</do_if>
									
									<do_if value="$disable_flag">
										<set_value name="$text" exact="{92015, 2006}" comment="Disable" />
										<signal_cue_instantly cue="md.Interact_Menu_API.Add_Action" param = "table[
											$id = 'order_attack_disable',
											$section = $section,
											$text = $text,
											$icon = 'order_attack',
											$callback = InteractMenu_OnAttackSubSys,
											$echo='disable'
										]" />					
									</do_if>
								</do_if>

								<do_if value="$target.isclass.station">		
									<find_object_component name="$subsys" object="$target" class="[class.dockarea]" checkoperational="false" integrated="false" indestructible="false" invulnerable="false" multiple="false">
										<match state="componentstate.wreck" negate="true"/>
									</find_object_component>									
									<do_if value="$subsys">
										<set_value name="$text" exact="{92015, 2007}" comment="Attack Station Docks" />
										<signal_cue_instantly cue="md.Interact_Menu_API.Add_Action" param = "table[
											$id = 'order_attack_stationdocks',
											$section = $section,
											$text = $text,
											$icon = 'order_attack',
											$callback = InteractMenu_OnAttackSubSys,
											$echo='stationdocks'
										]" />
									</do_if>

									<find_object_component name="$subsys" object="$target" class="[class.storage]" checkoperational="false" integrated="false" indestructible="false" invulnerable="false" multiple="false">
										<match state="componentstate.wreck" negate="true"/>
									</find_object_component>															
									<do_if value="$subsys">
										<set_value name="$text" exact="{92015, 2008}" comment="Attack Station Storage" />
										<signal_cue_instantly cue="md.Interact_Menu_API.Add_Action" param = "table[
											$id = 'order_attack_stationstorage',
											$section = $section,
											$text = $text,
											$icon = 'order_attack',
											$callback = InteractMenu_OnAttackSubSys,
											$echo='stationstorage'
										]" />
									</do_if>

									<find_object_component name="$subsys" object="$target" class="[class.production]" checkoperational="false" integrated="false" indestructible="false" invulnerable="false" multiple="false">
										<match state="componentstate.wreck" negate="true"/>
									</find_object_component>									
									<do_if value="$subsys">
										<set_value name="$text" exact="{92015, 2009}" comment="Attack Station Production" />
										<signal_cue_instantly cue="md.Interact_Menu_API.Add_Action" param = "table[
											$id = 'order_attack_stationproduction',
											$section = $section,
											$text = $text,
											$icon = 'order_attack',
											$callback = InteractMenu_OnAttackSubSys,
											$echo='stationproduction'
										]" />
									</do_if>

									<find_object_component name="$subsys" object="$target" class="[class.defencemodule]" checkoperational="false" integrated="false" indestructible="false" invulnerable="false" multiple="false">
										<match state="componentstate.wreck" negate="true"/>
									</find_object_component>													
									<do_if value="$subsys">
										<set_value name="$text" exact="{92015, 2010}" comment="Attack Station Def. Platforms" />
										<signal_cue_instantly cue="md.Interact_Menu_API.Add_Action" param = "table[
											$id = 'order_attack_stationdefense',
											$section = $section,
											$text = $text,
											$icon = 'order_attack',
											$callback = InteractMenu_OnAttackSubSys,
											$echo='stationdefense'
										]" />			
									</do_if>
									
									<find_object_component name="$subsys" object="$target" class="[class.buildmodule]" checkoperational="false" integrated="false" indestructible="false" invulnerable="false" multiple="false">
										<match state="componentstate.wreck" negate="true"/>
									</find_object_component>													
									<do_if value="$subsys">
										<set_value name="$text" exact="{92015, 2011}" comment="Attack Station Shipyard Platforms" />
										<signal_cue_instantly cue="md.Interact_Menu_API.Add_Action" param = "table[
											$id = 'order_attack_stationbuild',
											$section = $section,
											$text = $text,
											$icon = 'order_attack',
											$callback = InteractMenu_OnAttackSubSys,
											$echo='stationbuild'
										]" />			
									</do_if>

								</do_if>
							</do_if>						
						</do_if>	
						<do_if value="($ship and $ship.owner == faction.player) or ($target and $target.owner == faction.player)">
							<set_value name="$section" exact="'interaction'" />
							
							<set_value name="$text" exact="{92015, 2012}" comment="Clear Turret Subsystem Target" />
							<signal_cue_instantly cue="md.Interact_Menu_API.Add_Action" param = "table[
								$id = 'action_clear_turret_subsys_pref',
								$section = $section,
								$text = $text,
								$icon = 'order_lasertower',
								$callback = InteractMenu_OnClearTurretPrefs
							]" />
							
							<set_value name="$section" exact="'selected_orders'" />
							
							<set_value name="$text" exact="{92015, 2012}" comment="Clear Turret Subsystem Target" />
							<signal_cue_instantly cue="md.Interact_Menu_API.Add_Action" param = "table[
								$id = 'order_clear_turret_subsys',
								$section = $section,
								$text = $text,
								$icon = 'order_lasertower',
								$callback = InteractMenu_OnClearTurretPrefs
							]" />
						</do_if>
						<cancel_cue cue="this" />
					</actions>
				</cue>
				<cue name="InteractMenu_OnAttackSubSys">
					<conditions>
						<event_cue_signalled />
					</conditions>
					<actions>
						<set_value name="$subsyspref" exact="event.param.$echo" />						
						<set_value name="$doaction" exact="true" />
						<set_value name="$immed" exact="false" />
						
						<do_if value="event.param.$id == 'hk_attack_subsystem_whk' or event.param.$id == 'hk_attack_shields_whk' or event.param.$id == 'hk_attack_m_turrets_whk' or event.param.$id == 'hk_attack_l_turrets_whk' or event.param.$id == 'hk_attack_missturr_whk' or event.param.$id == 'hk_attack_batteries_whk' or event.param.$id == 'hk_attack_disable_whk' or event.param.$id == 'hk_attack_stationdocks_whk' or event.param.$id == 'hk_attack_stationstorage_whk' or event.param.$id == 'hk_attack_stationproduction_whk' or event.param.$id == 'hk_attack_stationdefense_whk' or event.param.$id == 'hk_attack_stationbuild_whk'">
							<set_value name="$target" exact="player.target" />
							
							<set_value name="$validselection" exact="((@player.entity.$SelectedFleetCommander and @player.entity.$SelectedFleetCommander != player.occupiedship) or (@player.entity.$SelectedWing and @player.entity.$SelectedFleetCommander.activesubordinategroupids.indexof.{@player.entity.$SelectedWingID}))" />
							
							<do_if value="($target.iscapitalship or $target.isclass.station) and (not ($target.owner == faction.player))   and $validselection">
								<speak actor="player.computer" page="10002" line="132" /> <!--"Command Accepted"-->
								<show_notification text="player.entity.$SelectedFleet + '-' + player.entity.$SelectedWing + ': ' + $subsyspref + ' ' + {92015, 2} + ' ' + {10002, 132}"/> <!--"Flt: Subsyspref Command Accepted"-->
								<set_value name="$immed" exact="true" />
							</do_if>
							<do_else>
								<speak actor="player.computer" page="10002" line="133" /> <!--"Command Rejected"-->
								<show_notification text="player.entity.$SelectedFleet + '-' + player.entity.$SelectedWing + ': ' + $subsyspref + ' ' + {92015, 2} + ' ' + {10002, 133}"/> <!--"Flt: Subsyspref Command Rejected"-->
								<set_value name="$doaction" exact="false" />		
							</do_else>
						</do_if>
						<do_else>
							<set_value name="$target" exact="event.param.$object" />
						</do_else>
						
						<do_if value="$doaction">						
							<do_if value="$subsyspref == 'Wing: engines' or $subsyspref == 'Wing: shields' or $subsyspref == 'Wing: weps_m' or $subsyspref == 'Wing: weps_l' or $subsyspref == 'Wing: missiles' or $subsyspref == 'Wing: batteries' or $subsyspref == 'Wing: disable' or $subsyspref == 'Wing: stationdocks' or $subsyspref == 'Wing: stationstorage' or $subsyspref == 'Wing: stationproduction' or $subsyspref == 'Wing: stationdefense' or $subsyspref == 'Wing: stationbuild'">
															
								<do_if value="@player.entity.$SelectedWing and 
									@player.entity.$SelectedFleetCommander.activesubordinategroupids.indexof.{@player.entity.$SelectedWingID}">						
									<set_value name="$orderships" exact="@player.entity.$SelectedFleetCommander.subordinatesingroup.{@player.entity.$SelectedWingID}" />
								</do_if>
								<do_else>
									<set_value name="$orderships" exact="[@player.entity.$SelectedFleetCommander]" />
								</do_else>
								
								<substitute_text text="$subsyspref">
									<replace string="'Wing: '" with="''" />
								</substitute_text>
							</do_if>
							<do_else>
								<set_value name="$orderships" exact="@event.param.$selectedplayerships" />
							</do_else>
							
							<do_for_each name="$ship" in="@$orderships">						
								<debug_text text="'$ship: ' + $ship + ' (' + @$ship.knownname + ')'" chance="alASTO.$debugChance" />
								<do_if value="$ship">
									<create_order name="$order" object="$ship" id="'Attack'" immediate="$immed">
										<param name="primarytarget" value="$target" />
										<param name="subsystemfocus" value="$subsyspref" />
										<param name="debugchance" value="alASTO.$debugChance" />
									</create_order>
								</do_if>
							</do_for_each>
						</do_if>
						<reset_cue cue="this" />
					</actions>
				</cue>			
				<cue name="InteractMenu_OnClearTurretPrefs">
					<conditions>
						<event_cue_signalled />
					</conditions>
					<actions>
						<set_value name="$target" exact="event.param.$object" />
						<do_if value="@$target.owner == faction.player">
							<set_value name="$target.pilot.$SubTargetPref" exact="''"/>
						</do_if>
						
						<do_if value="$subsyspref == 'Wing: clearturretsubyspref'">
												
							<do_if value="event.param.$id == 'hk_clear_turret_subsys_pref_whk'">
							
								<set_value name="$validselection" exact="((@player.entity.$SelectedFleetCommander and @player.entity.$SelectedFleetCommander != player.occupiedship) or (@player.entity.$SelectedWing and @player.entity.$SelectedFleetCommander.activesubordinategroupids.indexof.{@player.entity.$SelectedWingID}))" />
							
								<do_if value="$validselection">
									<speak actor="player.computer" page="10002" line="135" /> <!--"Cancelled"-->
									<show_notification text="player.entity.$SelectedFleet + '-' + player.entity.$SelectedWing + ': ' + {92015, 5007} + ' ' + {10002, 132}"/> <!--"Flt: Clear Turret SUbsystem Target Command Accepted"-->
								</do_if>
							</do_if>

						
							<do_if value="@player.entity.$SelectedWing and 
								@player.entity.$SelectedFleetCommander.activesubordinategroupids.indexof.{@player.entity.$SelectedWingID}">						
								<set_value name="$orderships" exact="@player.entity.$SelectedFleetCommander.subordinatesingroup.{@player.entity.$SelectedWingID}" />
							</do_if>
							<do_else>
								<set_value name="$orderships" exact="[@player.entity.$SelectedFleetCommander]" />
							</do_else>

						
							<substitute_text text="$subsyspref">
								<replace string="'Wing: '" with="''" />
							</substitute_text>
						</do_if>
						<do_else>
							<set_value name="$orderships" exact="@event.param.$selectedplayerships" />
						</do_else>
						
						<do_for_each name="$ship" in="@$orderships">						
							<debug_text text="'$ship: ' + $ship + ' (' + @$ship.knownname + ')'" chance="alASTO.$debugChance" />
							<do_if value="$ship">
								<set_value name="$ship.pilot.$SubTargetPref" exact="''"/>
							</do_if>
						</do_for_each>
						<reset_cue cue="this" />
					</actions>
				</cue>							
				<cue name="OnModInstallComplete">
					<actions>
						<set_value name="$debugChance" exact="0" />
						<debug_text text="'$debugChance: ' + $debugChance" />
					</actions>
				</cue>
			</cues>
		</cue>
	</cues>
</mdscript>