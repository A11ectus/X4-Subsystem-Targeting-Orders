<?xml version="1.0" encoding="iso-8859-1" ?>

<diff>

  <replace sel="//aiscript/attention[@min='visible']/actions/do_if[@value='this.ship.pilot and (@$targets.count or $dronetargets.count or ($miningtargets.count and this.ship == player.occupiedship))']/do_else/do_if[@value='$incomingmissiles.count and $turretmodes.indexof.{weaponmode.missiledefence}']">
	<do_if value="($incomingmissiles.count or $targets_fighters.count) and $turretmodes.indexof.{weaponmode.missiledefence}">
		<create_group groupname="$targets_final"/>
		<add_to_group groupname="$targets_final" group="$incomingmissiles"/>

		<set_value name="$locpreferred" exact="$preferredtarget"/>
		
		<do_if value="$incomingmissiles.count">
			<do_if value="$locpreferred">
				<do_if value="not $incomingmissiles.indexof.{$locpreferred}">
					<set_value name="$locpreferred" exact="$incomingmissiles.random"/>
				</do_if>
			</do_if>
			<do_else>
				<set_value name="$locpreferred" exact="$incomingmissiles.random"/>
			</do_else>
		</do_if>
		<do_else>
			<add_to_group groupname="$targets_final" group="$targets_fighters"/>
			
			<do_if value="$locpreferred">
				<do_if value="not $targets_fighters.indexof.{$locpreferred}">
					<set_value name="$locpreferred" exact="$targets_fighters.random"/>
				</do_if>
			</do_if>
			<do_else>
				<set_value name="$locpreferred" exact="$targets_fighters.random"/>
			</do_else>		
		</do_else>
		
		<debug_text text="'%s %s missile defence active.'.[$incomingmissiles.count, $locpreferred]" chance="100"/>
	
		<set_turret_targets object="this.assignedcontrolled" target="$targets_final.list" weaponmode="weaponmode.missiledefence" preferredtarget="$locpreferred"/>
		<remove_value name="$targets_final"/>		
    </do_if>
  </replace>
  
  <replace sel="//aiscript/attention[@min='visible']/actions/do_if[@value='this.ship.pilot and (@$targets.count or $dronetargets.count or ($miningtargets.count and this.ship == player.occupiedship))']/do_else/do_if[@value='$targets_fighters.count and $turretmodes.indexof.{weaponmode.attackfighters}']">
  
  <!--
	<do_if value="($targets_fighters.count or $incomingmissiles.count) and $turretmodes.indexof.{weaponmode.attackfighters}">
	-->
	<do_if value="($targets_fighters.count or $incomingmissiles.count or $targets_capital.count) and $turretmodes.indexof.{weaponmode.attackfighters}">
		<create_group groupname="$targets_final"/>
		<!--<add_to_group groupname="$targets_final" group="$targets_fighters"/>-->
		<set_value name="$locpreferred" exact="$preferredtarget"/>
		<set_value name="$locsubsyspref" exact="this.controllable.pilot.$SubTargetPref"/>
		
		<debug_text text="'%s %s (d1) Attack fighters  active.'.[$locsubsyspref, $locpreferred]" chance="100"/>
		
		<do_if value="$locsubsyspref == 'targetsubengines'">
			<do_for_each name="$capitaltarget" in="$targets_capital.list">
				<find_object_component name="$locsecondarytargets" object="$capitaltarget" class="class.engine" checkoperational="true" indestructible="false" invulnerable="false" integrated="false" multiple="true"/>	  
				
				<do_if value="$locsecondarytargets.count">
					<add_to_group groupname="$targets_final" list="$locsecondarytargets"/>
				</do_if>
			</do_for_each>
			
			<do_if value="$locpreferred and not $targets_final.indexof.{$locpreferred}">            
				<set_value name="$locpreferred" exact="$targets_final.{1}"/>
			</do_if>
			<do_else>
				<set_value name="$locpreferred" exact="$targets_final.{1}"/>
			</do_else>
			
			<!--
			<do_for_each name="$subsys" in="$targets_final.list">
				<check_line_of_sight object="this.ship" target="$subsys" name="$isinview" />				
				
				<do_if value="$isinview">
					<set_value name="$locpreferred" exact="$subsys"/>
					<break/>
				</do_if>
			</do_for_each>
			-->
			
			<debug_text text="'%s %s (d2) Attack engines active. targets_final %s'.[$locsubsyspref, $locpreferred, $targets_final]" chance="100"/>
		</do_if>
		
		<!--
		<do_if value="$targets_fighters.count">
			<do_if value="$locpreferred">
				<do_if value="not $targets_fighters.indexof.{$locpreferred}">
					<set_value name="$locpreferred" exact="$targets_fighters.random"/>
				</do_if>
			</do_if>
			<do_else>
				<set_value name="$locpreferred" exact="$targets_fighters.random"/>
			</do_else>
		</do_if>
		<do_else>
			<add_to_group groupname="$targets_final" group="$incomingmissiles"/>
			
			<do_if value="$locpreferred">
				<do_if value="not $incomingmissiles.indexof.{$locpreferred}">
					<set_value name="$locpreferred" exact="$incomingmissiles.random"/>
				</do_if>
			</do_if>
			<do_else>
				<set_value name="$locpreferred" exact="$incomingmissiles.random"/>
			</do_else>		
		</do_else>
		-->
		<debug_text text="'%s %s (d4) Attack fighters active.'.[$targets_fighters.count, $locpreferred]" chance="100"/>
	
		<set_turret_targets object="this.assignedcontrolled" target="$targets_final.list" weaponmode="weaponmode.attackfighters" preferredtarget="$locpreferred"/>
		<remove_value name="$targets_final"/>			
    </do_if>
  </replace>

</diff>
